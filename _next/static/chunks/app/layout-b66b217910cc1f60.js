(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{1056:(e,t,a)=>{"use strict";a.d(t,{EJ:()=>g,R2:()=>c,lR:()=>o,lW:()=>h,qs:()=>d});let r=a(9509).env.NEXT_PUBLIC_API_URL||"https://xzatkvsdyvij.sealosbja.site",s={login:"".concat(r,"/api/auth/login"),register:"".concat(r,"/api/auth/register"),me:"".concat(r,"/api/auth/me"),updateProfile:"".concat(r,"/api/auth/profile"),changePassword:"".concat(r,"/api/auth/password"),logout:"".concat(r,"/api/auth/logout"),verify:"".concat(r,"/api/auth/verify")},i="blog_auth_user",n="blog_auth_token";class o extends Error{constructor(e,t,a){super(t),this.code=e,this.field=a,this.name="AuthError"}}class l{getAuthHeaders(){let e=localStorage.getItem(n);return{"Content-Type":"application/json",...e&&{Authorization:"Bearer ".concat(e)}}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let i=await fetch(e,{...t,headers:{...this.getAuthHeaders(),...t.headers}}),n=await i.json();if(!n.success){var a,r,s;throw new o((null==(a=n.error)?void 0:a.code)||"API_ERROR",(null==(r=n.error)?void 0:r.message)||n.message||"请求失败",null==(s=n.error)?void 0:s.field)}return n.data}catch(e){if(e instanceof o)throw e;throw new o("NETWORK_ERROR","网络连接失败，请检查后端服务是否启动")}}async post(e,t){return this.request(e,{method:"POST",body:t?JSON.stringify(t):void 0})}async get(e){return this.request(e,{method:"GET"})}async put(e,t){return this.request(e,{method:"PUT",body:t?JSON.stringify(t):void 0})}}let u=new l,c={login:async e=>await u.post(s.login,e),async register(e){let{confirmPassword:t,...a}=e;return await u.post(s.register,a)},async logout(){try{await u.post(s.logout)}catch(e){console.warn("Logout API failed, but clearing local storage:",e)}},async getCurrentUser(){if(!localStorage.getItem(n))return null;try{return await u.get(s.me)}catch(e){return localStorage.removeItem(n),localStorage.removeItem(i),null}},async updateProfile(e,t){let a={displayName:t.displayName,bio:t.bio,avatar:t.avatar};return await u.put(s.updateProfile,a)},async changePassword(e,t,a){await u.put(s.changePassword,{oldPassword:t,newPassword:a})},async verifyToken(){if(!localStorage.getItem(n))return!1;try{return await u.get(s.verify),!0}catch(e){return!1}}},d={saveUser(e,t){localStorage.setItem(i,JSON.stringify(e)),localStorage.setItem(n,t)},getUser(){try{let e=localStorage.getItem(i);return e?JSON.parse(e):null}catch(e){return null}},getToken:()=>localStorage.getItem(n),clearUser(){localStorage.removeItem(i),localStorage.removeItem(n)}},g={validateEmail:e=>e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?null:"请输入有效的邮箱地址":"请输入邮箱地址",validatePassword:e=>e?e.length<6?"密码至少需要6个字符":null:"请输入密码",validateUsername:e=>e?e.length<3?"用户名至少需要3个字符":/^[a-zA-Z0-9_]+$/.test(e)?null:"用户名只能包含字母、数字和下划线":"请输入用户名",validateDisplayName:e=>e?e.length<2?"显示名称至少需要2个字符":e.length>50?"显示名称不能超过50个字符":null:"请输入显示名称",validatePasswordConfirm:(e,t)=>t?e!==t?"两次输入的密码不一致":null:"请确认密码"},h={isAdmin:e=>(null==e?void 0:e.role)==="ADMIN",canEdit:e=>(null==e?void 0:e.role)==="ADMIN"||(null==e?void 0:e.role)==="EDITOR",canAccessProfile(e,t){return(null==e?void 0:e.id)===t||this.isAdmin(e)}}},2612:(e,t,a)=>{Promise.resolve().then(a.t.bind(a,9324,23)),Promise.resolve().then(a.bind(a,3274))},3274:(e,t,a)=>{"use strict";a.d(t,{As:()=>l,AuthProvider:()=>o,Nu:()=>u});var r=a(5155),s=a(2115),i=a(1056);let n=(0,s.createContext)(void 0);function o(e){let{children:t}=e,[a,o]=(0,s.useState)({user:null,isLoading:!0,isAuthenticated:!1}),[l,u]=(0,s.useState)(null);(0,s.useEffect)(()=>{c()},[]);let c=async()=>{try{o(e=>({...e,isLoading:!0}));let e=i.qs.getUser(),t=i.qs.getToken();if(e&&t){let e=await i.R2.getCurrentUser();if(e)return void o({user:e,isLoading:!1,isAuthenticated:!0})}i.qs.clearUser(),o({user:null,isLoading:!1,isAuthenticated:!1})}catch(e){console.error("初始化认证状态失败:",e),i.qs.clearUser(),o({user:null,isLoading:!1,isAuthenticated:!1})}},d=async e=>{try{o(e=>({...e,isLoading:!0})),u(null);let{user:t,token:a}=await i.R2.login(e);i.qs.saveUser(t,a),o({user:t,isLoading:!1,isAuthenticated:!0})}catch(e){throw o(e=>({...e,isLoading:!1})),e instanceof i.lR?u(e):u(new i.lR("UNKNOWN_ERROR","登录失败，请重试")),e}},g=async e=>{try{o(e=>({...e,isLoading:!0})),u(null);let{user:t,token:a}=await i.R2.register(e);i.qs.saveUser(t,a),o({user:t,isLoading:!1,isAuthenticated:!0})}catch(e){throw o(e=>({...e,isLoading:!1})),e instanceof i.lR?u(e):u(new i.lR("UNKNOWN_ERROR","注册失败，请重试")),e}},h=async()=>{try{o(e=>({...e,isLoading:!0})),await i.R2.logout(),i.qs.clearUser(),o({user:null,isLoading:!1,isAuthenticated:!1}),u(null)}catch(e){console.error("退出登录失败:",e),i.qs.clearUser(),o({user:null,isLoading:!1,isAuthenticated:!1})}},w=async e=>{if(!a.user)throw new i.lR("NOT_AUTHENTICATED","请先登录");try{o(e=>({...e,isLoading:!0})),u(null);let t=await i.R2.updateProfile(a.user.id,e),r=i.qs.getToken();r&&i.qs.saveUser(t,r),o(e=>({...e,user:t,isLoading:!1}))}catch(e){throw o(e=>({...e,isLoading:!1})),e instanceof i.lR?u(e):u(new i.lR("UPDATE_FAILED","更新资料失败，请重试")),e}},v=async(e,t)=>{if(!a.user)throw new i.lR("NOT_AUTHENTICATED","请先登录");try{o(e=>({...e,isLoading:!0})),u(null),await i.R2.changePassword(a.user.id,e,t),o(e=>({...e,isLoading:!1}))}catch(e){throw o(e=>({...e,isLoading:!1})),e instanceof i.lR?u(e):u(new i.lR("PASSWORD_CHANGE_FAILED","修改密码失败，请重试")),e}},y={...a,login:d,register:g,logout:h,updateProfile:w,changePassword:v,error:l,clearError:()=>{u(null)}};return(0,r.jsx)(n.Provider,{value:y,children:t})}function l(){let e=(0,s.useContext)(n);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function u(){let e=l();return(0,s.useEffect)(()=>{e.isLoading||e.isAuthenticated||console.warn("用户未登录，需要登录后访问")},[e.isLoading,e.isAuthenticated]),e}},9324:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[533,441,684,358],()=>t(2612)),_N_E=e.O()}]);